#!/bin/bash
set -e

# Detect root partition PARTUUID
ROOT_PARTUUID=$(findmnt -no PARTUUID /)

# Update system
sudo pacman -Syu --noconfirm

# Install base packages + linux-zen kernel
sudo pacman -S --noconfirm base base-devel linux linux-headers \
    linux-zen linux-zen-headers linux-firmware \
    networkmanager bluez bluez-utils \
    mesa vulkan-radeon lib32-mesa lib32-vulkan-radeon \
    steam flameshot

# Enable services
sudo systemctl enable --now NetworkManager
sudo systemctl enable --now bluetooth

# Ensure systemd-boot is installed
bootctl install

# Create Arch Linux entry (regular kernel)
cat <<EOF | sudo tee /boot/loader/entries/arch.conf
title   Arch Linux (default kernel)
linux   /vmlinuz-linux
initrd  /initramfs-linux.img
options root=PARTUUID=$ROOT_PARTUUID rw
EOF

# Create Arch Linux entry (Zen kernel)
cat <<EOF | sudo tee /boot/loader/entries/arch-zen.conf
title   Arch Linux (Zen kernel)
linux   /vmlinuz-linux-zen
initrd  /initramfs-linux-zen.img
options root=PARTUUID=$ROOT_PARTUUID rw
EOF

# Configure systemd-boot loader with 5s timeout, default Zen kernel
cat <<EOF | sudo tee /boot/loader/loader.conf
default arch-zen.conf
timeout 5
editor no
EOF

echo "Installation complete. Reboot to use Arch Linux (Zen kernel) by default."
echo "You will have 5 seconds to pick a different kernel at boot."
