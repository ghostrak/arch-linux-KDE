#!/bin/bash
# Automated Arch Linux + KDE Plasma Installer (UEFI, ext4, swap)
# Includes Wi-Fi, Bluetooth, Steam, Flameshot, and essential apps

set -e

echo "=== Arch Linux KDE Installer ==="

# --- User input ---
read -p "Enter hostname: " HOSTNAME
read -p "Enter username: " USERNAME
read -sp "Enter password for $USERNAME: " PASSWORD
echo
read -sp "Enter root password: " ROOTPASS
echo
read -p "Enter target disk (e.g. /dev/nvme0n1 or /dev/sda): " DISK

# --- Partitioning (UEFI + ext4 + swap) ---
echo "Partitioning $DISK..."
parted -s "$DISK" mklabel gpt
parted -s "$DISK" mkpart ESP fat32 1MiB 513MiB
parted -s "$DISK" set 1 esp on
parted -s "$DISK" mkpart primary ext4 513MiB 100%

# --- Formatting ---
mkfs.fat -F32 "${DISK}p1"
mkfs.ext4 -F "${DISK}p2"

# --- Mounting ---
mount "${DISK}p2" /mnt
mkdir /mnt/boot
mount "${DISK}p1" /mnt/boot

# --- Base system install ---
pacstrap /mnt base linux linux-firmware vim sudo networkmanager \
    git curl dolphin konsole firefox libreoffice discord \
    iwd wpa_supplicant wireless_tools \
    bluez bluez-utils bluedevil \
    flameshot plasma-meta sddm

# --- Fstab ---
genfstab -U /mnt >> /mnt/etc/fstab

# --- Chroot ---
arch-chroot /mnt /bin/bash <<EOF
# Timezone & locale
ln -sf /usr/share/zoneinfo/UTC /etc/localtime
hwclock --systohc
echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
locale-gen
echo "LANG=en_US.UTF-8" > /etc/locale.conf

# Hostname
echo "$HOSTNAME" > /etc/hostname

# Root password
echo "root:$ROOTPASS" | chpasswd

# User account
useradd -m -G wheel -s /bin/bash "$USERNAME"
echo "$USERNAME:$PASSWORD" | chpasswd
echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers

# Enable multilib (for Steam)
sed -i '/\[multilib\]/,/Include/s/^#//' /etc/pacman.conf
pacman -Sy --noconfirm

# Install Steam
pacman -S --noconfirm steam steam-native-runtime

# Bootloader (systemd-boot)
bo
